"use strict";(self.webpackChunkflutter_rust_bridge=self.webpackChunkflutter_rust_bridge||[]).push([[912],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>d});var r=n(67294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=r.createContext({}),u=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},c=function(e){var t=u(e.components);return r.createElement(l.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},m=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,i=e.originalType,l=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),m=u(n),d=a,f=m["".concat(l,".").concat(d)]||m[d]||p[d]||i;return n?r.createElement(f,o(o({ref:t},c),{},{components:n})):r.createElement(f,o({ref:t},c))}));function d(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=n.length,o=new Array(i);o[0]=m;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:a,o[1]=s;for(var u=2;u<i;u++)o[u]=n[u];return r.createElement.apply(null,o)}return r.createElement.apply(null,n)}m.displayName="MDXCreateElement"},98063:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>p,frontMatter:()=>i,metadata:()=>s,toc:()=>u});var r=n(87462),a=(n(67294),n(3905));const i={},o="Monorepo with Melos",s={unversionedId:"manual/integrate/library/overview/melos",id:"manual/integrate/library/overview/melos",title:"Monorepo with Melos",description:"This page covers the basics of how to setup and use Melos,",source:"@site/docs/manual/integrate/07-library/01-overview/02-melos.md",sourceDirName:"manual/integrate/07-library/01-overview",slug:"/manual/integrate/library/overview/melos",permalink:"/flutter_rust_bridge/manual/integrate/library/overview/melos",draft:!1,editUrl:"https://github.com/fzyzcjy/flutter_rust_bridge/tree/master/website/docs/manual/integrate/07-library/01-overview/02-melos.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Setup",permalink:"/flutter_rust_bridge/manual/integrate/library/overview/setup"},next:{title:"Creating the libraries",permalink:"/flutter_rust_bridge/manual/integrate/library/creating-libraries/"}},l={},u=[{value:"<code>/melos.yaml</code>",id:"melosyaml",level:2},{value:"<code>/scripts/version.sh</code>",id:"scriptsversionsh",level:2},{value:"Conventional Commits",id:"conventional-commits",level:2}],c={toc:u};function p(e){let{components:t,...n}=e;return(0,a.kt)("wrapper",(0,r.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"monorepo-with-melos"},"Monorepo with Melos"),(0,a.kt)("p",null,"This page covers the basics of how to setup and use ",(0,a.kt)("a",{parentName:"p",href:"https://melos.invertase.dev"},"Melos"),",\na Dart/Flutter focused monorepo tool, so you can use it to manage your own monorepo."),(0,a.kt)("p",null,"While you can, in theory, go about this guide without using Melos,\n",(0,a.kt)("em",{parentName:"p"},"using Melos will save you a lot of time and headache"),".\nThere is some slight upfront cost of configuring and learning how Melos works,\nbut it pays off substantially in the long-term."),(0,a.kt)("p",null,"The rest of this guide assumes you are using Melos, so here are the steps to setup Melos,\nalong with some common commands."),(0,a.kt)("p",null,"It is also highly recommended that you read the Melos documentation linked above, as this\npage only covers the bare minimum and it is likely you will want to do more than listed here."),(0,a.kt)("h2",{id:"melosyaml"},(0,a.kt)("inlineCode",{parentName:"h2"},"/melos.yaml")),(0,a.kt)("p",null,"Here is a sample of Melos' configuration file to get you started:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},'name: library_name\n\nrepository: https://github.com/YourGitHubAccount/library_name\n\npackages:\n  - packages/**\n\nscripts:\n  analyze:\n    exec: flutter analyze .\n    description: Analyze a specific package in this project.\n\n  check-format:\n    exec: dart format --set-exit-if-changed .\n    description: Check the format of a specific package in this project.\n\n  format:\n    exec: dart format .\n    description: Format a specific package in this project.\n\n  version:\n    description: Updates version numbers in all build files\n    run: bash scripts/version.sh\n\n  build:\n    run: melos run build:apple && melos run build:android && melos run build:other\n    description: Build all native libraries for the project.\n\n  build:apple:\n    run: bash scripts/build-apple.sh\n    description: Build the XCFramework for iOS and macOS.\n\n  build:android:\n    run: bash scripts/build-android.sh\n    description: Build the .tar.gz for Android.\n\n  build:other:\n    run: bash scripts/build-other.sh\n    description: Build the .tar.gz for all other platforms.\n\n  test:\n    run: melos run test:dart --no-select && melos run test:flutter --no-select\n    description: Run all Dart & Flutter tests in this project.\n\n  test:dart:\n    run: melos exec -c 1 --fail-fast -- "dart test test"\n    description: Run Dart tests for a specific package in this project.\n    select-package:\n      flutter: false\n      dir-exists: test\n\n  test:flutter:\n    run: melos exec -c 1 --fail-fast -- "flutter test test"\n    description: Run Flutter tests for a specific package in this project.\n    select-package:\n      flutter: true\n      dir-exists: test\n')),(0,a.kt)("p",null,'You can run the melos "scripts" defined in this file with ',(0,a.kt)("inlineCode",{parentName:"p"},"melos run ..."),",\ne.g. ",(0,a.kt)("inlineCode",{parentName:"p"},"melos run build:android")," to build a .tar.gz for Android devices.\nAlso, when you first setup your Melos repo, you will need to run ",(0,a.kt)("inlineCode",{parentName:"p"},"melos bootstrap")," (or ",(0,a.kt)("inlineCode",{parentName:"p"},"melos bs")," for short).\nTo clean your repo in the future, you can run ",(0,a.kt)("inlineCode",{parentName:"p"},"melos clean && melos bs"),"."),(0,a.kt)("h2",{id:"scriptsversionsh"},(0,a.kt)("inlineCode",{parentName:"h2"},"/scripts/version.sh")),(0,a.kt)("p",null,"Every time you need to make a new release of your library, Melos will take care of the heavy lifting for you.\nMelos creates new versions via the simple command, ",(0,a.kt)("inlineCode",{parentName:"p"},"melos version"),".\n",(0,a.kt)("inlineCode",{parentName:"p"},"melos version")," creates and manages git tags, in addition to automatically incrementing the version numbers appropriately."),(0,a.kt)("p",null,'Since we are distributing our binaries separately from the Dart/Flutter packages on pub.dev, we take advantage of\na special "melos script" defined in the configuration file, named "version".\nIn this versioning script, we change the version numbers for our Flutter build process so that consumers of our library\nwill always get the binaries associated with their version.'),(0,a.kt)("p",null,"Replace all instances of ",(0,a.kt)("inlineCode",{parentName:"p"},"library_name")," below with your library name."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'#!/bin/bash\n\nCURR_VERSION=library_name-v`awk \'/^version: /{print $2}\' packages/library_name/pubspec.yaml`\n\n# iOS & macOS\nAPPLE_HEADER="release_tag_name = \'$CURR_VERSION\' # generated; do not edit"\nsed -i.bak "1 s/.*/$APPLE_HEADER/" packages/flutter_library_name/ios/flutter_library_name.podspec\nsed -i.bak "1 s/.*/$APPLE_HEADER/" packages/flutter_library_name/macos/flutter_library_name.podspec\nrm packages/flutter_library_name/macos/*.bak packages/flutter_library_name/ios/*.bak\n\n# CMake platforms (Linux, Windows, and Android)\nCMAKE_HEADER="set(LibraryVersion \\"$CURR_VERSION\\") # generated; do not edit"\nfor CMAKE_PLATFORM in android linux windows\ndo\n    sed -i.bak "1 s/.*/$CMAKE_HEADER/" packages/flutter_library_name/$CMAKE_PLATFORM/CMakeLists.txt\n    rm packages/flutter_library_name/$CMAKE_PLATFORM/*.bak\ndone\n\ngit add packages/flutter_library_name/\n')),(0,a.kt)("h2",{id:"conventional-commits"},"Conventional Commits"),(0,a.kt)("p",null,'For Melos versioning to work, which our monorepo relies on to distribute binaries properly,\nyou need to use "conventional commits."\nIf you are not familiar with conventional commits, that is ok.\nSimply read up on conventional commits in the ',(0,a.kt)("a",{parentName:"p",href:"https://melos.invertase.dev/guides/automated-releases#versioning"},"Melos guide"),"."))}p.isMDXComponent=!0}}]);